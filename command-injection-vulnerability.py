import requests

def readFile(fileName):
  """Reads a file and returns a list of read lines
  Parameters:
  fileName (string) -- the name of the file (path and format included)
  """
  lines = []
  try:
    with open(fileName, 'r') as f:
      for line in f:
        lines.append(line.replace('\n', ''))
  except:
    raise Exception('File', urlsFile, 'doesn\'t exists')
  return lines

def getRequest(url, queryParams):
  if url:
    return requests.get(url, params=queryParams)
  return ''

def isCommandInjection(command, output):
  if 'ls' in command:
    return 'find-escapeshellcmd.php' in output and 'ping-no-amp.php' in output and 'echo.php' in output
  elif 'whoami' in command:
    return 'www-data' in output
  elif 'cat /etc/passwd' in command:
    # check fist two lines of /etc/passwd
    return 'root:x:0:0:root:/root:/bin/bash\ndaemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin' in output
  return False

httpString = 'http://'
host = input('Insert the host (default http://localhost): ')
if not host:
  host = 'http://localhost'
else:
  while not host.startswith(httpString) or len(host) <= len(httpString):
    host = input('Host not valid.\nInsert a valid host (ex. http://localhost): ')

urlsFile = input('Insert the URLs file name (default urls.txt): ')
if not urlsFile:
  urlsFile = 'urls.txt'
payloadsFile = input('Insert the payloads file name (default payloads.txt): ')
if not payloadsFile:
  payloadsFile = 'payloads.txt'

urls = readFile(urlsFile)
payloads = readFile(payloadsFile)

# Expected url format: /some/random/url/with-page.php:param1,param2,param3
for url in urls:
  splitted = url.split(':')
  if len(splitted) > 1:
    baseUrl = splitted[0].replace(':', ' ')
    params = splitted[1]
    paramsList = params.split(',')
    paramsListLen = len(paramsList)
    payloadsLen = len(payloads)

    if payloadsLen >= paramsListLen:
      for i in range(payloadsLen):
        # create query params for the request
        queryParams = {}
        w = i
        #print('i: ', i)
        for j in range(paramsListLen):
          # print('w: ', w)
          # print('j: ', j)
          index = w % payloadsLen
          payload = payloads[index]
          queryParams[paramsList[j]] = payload
          w += 1
        print('queryparams ', queryParams)
        result = getRequest(host + baseUrl, queryParams)
        if result.ok and result.text:
          #print('result:', result.text)
          for param in paramsList:
            payload = queryParams[param]
            if isCommandInjection(payload, result.text):
              print('Found a command injection on the "' + param + '" parameter in the "' + url + '" url using the "' + payload + '" payload')
    else:
      raise Exception('The number of parameters in "' + url +'" is greater than the number of possible payloads')
